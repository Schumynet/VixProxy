<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Streaming Film e Serie TV</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    :root {
      --primary: #e50914;
      --dark: #141414;
      --gray: #222;
      --light-gray: #8c8c8c;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: var(--dark);
      color: white;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      min-height: 100vh;
    }

    /* Header */
    .navbar {
      background: linear-gradient(to bottom, rgba(255,0,0,0.3) 0%, transparent 100%);
      padding: 20px 50px;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .logo {
      height: 40px;
    }

    /* Search Container */
    .search-container {
      max-width: 800px;
      width: 100%;
      margin: 120px auto 40px;
      padding: 0 20px;
    }

    .search-box {
      display: flex;
      position: relative;
      margin-bottom: 30px;
    }

    .search-input {
      flex: 1;
      padding: 15px 25px;
      font-size: 1.1rem;
      border: none;
      border-radius: 30px;
      background: rgba(255,255,255,0.1);
      color: white;
      backdrop-filter: blur(10px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .search-input:focus {
      outline: none;
      background: rgba(255,255,255,0.2);
      box-shadow: 0 5px 20px rgba(229, 9, 20, 0.3);
    }

    .search-button {
      position: absolute;
      right: 5px;
      top: 5px;
      bottom: 5px;
      width: 50px;
      background: var(--primary);
      border: none;
      border-radius: 25px;
      color: white;
      cursor: pointer;
      transition: all 0.3s;
    }

    .search-button:hover {
      background: #f40612;
    }

    /* Results */
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 25px;
      padding: 20px;
    }

    .media-card {
      background: var(--gray);
      border-radius: 10px;
      overflow: hidden;
      transition: transform 0.3s;
      cursor: pointer;
    }

    .media-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
    }

    .media-poster {
      width: 100%;
      height: 300px;
      object-fit: cover;
    }

    .media-info {
      padding: 15px;
    }

    .media-title {
      font-size: 1.1rem;
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .media-meta {
      display: flex;
      justify-content: space-between;
      color: var(--light-gray);
      font-size: 0.9rem;
    }

    /* States */
.state-message {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  padding: 30px;
  font-size: 1.2rem;
  color: var(--light-gray);
  width: 100%;
  max-width: 600px;
}

    .loading-spinner {
      display: inline-block;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Aggiungi questo allo stile esistente */
.filters {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin: 0 auto 30px;
  max-width: 400px;
}

.filter-btn {
  flex: 1;
  padding: 10px 0;
  background: rgba(255,255,255,0.1);
  border: none;
  border-radius: 30px;
  color: white;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.3s;
  backdrop-filter: blur(10px);
  text-align: center;
}

.filter-btn:hover {
  background: rgba(255,255,255,0.2);
}

.filter-btn.active {
  background: var(--primary);
  box-shadow: 0 0 10px rgba(229, 9, 20, 0.5);
}

/* Versione mobile */
@media (max-width: 768px) {
  .filters {
    gap: 10px;
    margin-bottom: 20px;
  }
  
  .filter-btn {
    padding: 8px 0;
    font-size: 0.8rem;
  }
}
    /* Player */
    .player-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .player-iframe {
      width: 80%;
      height: 80%;
      border: none;
      border-radius: 10px;
      display: none;
    }

    .close-player {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--primary);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 1.2rem;
      cursor: pointer;
    }

    .episode-selection-view {
  width: 90%;
  max-width: 1000px;
  height: 90%;
  overflow-y: auto;
  padding: 20px;
}

.episodes-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 20px;
  margin-top: 20px;
}
@media (max-width: 768px) {
  .episode-card {
    padding: 10px;
  }
  
  .episode-card img {
    max-height: 120px;
  }
  
  .episodes-grid {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
  }
}

.episode-card {
  background: var(--gray);
  padding: 15px;
  border-radius: 8px;
  cursor: pointer;
  transition: transform 0.3s;
  overflow: hidden; /* Nuovo - Contiene l'immagine */
}

.episode-card img {
  width: 100%;
  height: auto;
  border-radius: 5px;
  margin-top: 10px;
  object-fit: cover;
  max-height: 150px; /* Altezza massima */
  border: 1px solid rgba(255,255,255,0.1); /* Bordo sottile */
}

.episode-card:hover {
  transform: translateY(-5px);
}

.error-message {
  color: white;
  text-align: center;
  padding: 40px;
}

    /* Responsive */
    @media (max-width: 768px) {
      .navbar {
        padding: 15px;
      }

      .search-container {
        margin-top: 80px;
      }

      .results-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }

      .media-poster {
        height: 225px;
      }

      .player-iframe {
        width: 95%;
        height: 60%;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <img src="logo.png" alt="Logo" class="logo">
  </nav>

  <!-- Main Content -->
  <div class="search-container">
    <div class="search-box">
      <input 
        type="text" 
        class="search-input" 
        id="search-input" 
        placeholder="Cerca film o serie TV..."
        onkeyup="handleSearchKeyup(event)"
      >
      <button class="search-button" onclick="searchMedia()">
        <i class="fas fa-search"></i>
      </button>
    </div>

<div class="filters">
  <button class="filter-btn active" onclick="setFilter('all')">Tutti</button>
  <button class="filter-btn" onclick="setFilter('movie')">Film</button>
  <button class="filter-btn" onclick="setFilter('tv')">Serie TV</button>
</div>

    <div id="results-container" class="results-grid">
      <div class="state-message">
        <i class="fas fa-film"></i> Cerca film o serie TV per iniziare
      </div>
    </div>
  </div>

  <!-- Player -->
  <div class="player-container" id="player-container">
    <iframe class="player-iframe" id="player-iframe" allowfullscreen></iframe>
  </div>

  <script>
    let currentTVData = null; // Memorizza i dati della serie corrente
let isInEpisodeSelection = false; // Flag per lo stato di selezione episodi
    const API_KEY = "1e8c9083f94c62dd66fb2105cd7b613b";
    let currentFilter = 'all';

    // Handle Enter key
    function handleSearchKeyup(event) {
      if (event.key === 'Enter') {
        searchMedia();
      }
    }

    // Set filter
// MODIFICA la funzione setFilter così:
function setFilter(type) {
  currentFilter = type;
  // Aggiorna lo stato attivo di tutti i bottoni
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.remove('active');
    if ((type === 'all' && btn.textContent.includes('Tutti')) ||
        (type === 'movie' && btn.textContent.includes('Film')) ||
        (type === 'tv' && btn.textContent.includes('Serie'))) {
      btn.classList.add('active');
    }
  });

      searchMedia();
    }

    // Main search function
    async function searchMedia() {
      const query = document.getElementById("search-input").value.trim();
      const container = document.getElementById("results-container");
      
      if (!query) {
        container.innerHTML = `
          <div class="state-message">
            <i class="fas fa-film"></i> Inserisci un titolo per cercare
          </div>
        `;
        return;
      }

      // Show loading state
      container.innerHTML = `
        <div class="state-message">
          <i class="fas fa-spinner loading-spinner"></i> Ricerca in corso...
        </div>
      `;

      try {
        let movies = [];
        let tvShows = [];

        // Search movies if filter is 'all' or 'movie'
        if (currentFilter === 'all' || currentFilter === 'movie') {
          const moviesRes = await fetch(
            `https://api.themoviedb.org/3/search/movie?api_key=${API_KEY}&query=${encodeURIComponent(query)}&language=it-IT`
          );
          const moviesData = await moviesRes.json();
          movies = moviesData.results || [];
        }

        // Search TV shows if filter is 'all' or 'tv'
        if (currentFilter === 'all' || currentFilter === 'tv') {
          const tvRes = await fetch(
            `https://api.themoviedb.org/3/search/tv?api_key=${API_KEY}&query=${encodeURIComponent(query)}&language=it-IT`
          );
          const tvData = await tvRes.json();
          tvShows = tvData.results || [];
        }

        // Carica le liste di ID da VixSRC
// Carica le liste offline di VixSRC
// Carica i file locali
const [rawMovies, rawTV] = await Promise.all([
  fetch('vix-movies-ids.json').then(r => r.json()),
  fetch('vix-tv-ids.json').then(r => r.json())
]);

// Estrai solo gli ID in due array
const vixsrcMovieIds = rawMovies.map(entry => entry.tmdb_id);
const vixsrcTVIds = rawTV.map(entry => entry.tmdb_id);

// Filtra i risultati
const allResults = [...movies, ...tvShows].filter(item => {
  const isTV = !!item.first_air_date;
  return isTV ? vixsrcTVIds.includes(item.id) : vixsrcMovieIds.includes(item.id);
});




        if (allResults.length === 0) {
          container.innerHTML = `
            <div class="state-message">
              <i class="far fa-sad-tear"></i> Nessun risultato trovato
            </div>
          `;
          return;
        }

        // Display results
        container.innerHTML = allResults.map(item => {
          const isTV = item.first_air_date ? true : false;
          const poster = item.poster_path 
            ? `https://image.tmdb.org/t/p/w300${item.poster_path}`
            : 'https://via.placeholder.com/300x450?text=No+poster';
          
          const year = isTV 
            ? (item.first_air_date ? item.first_air_date.substring(0, 4) : 'N/D')
            : (item.release_date ? item.release_date.substring(0, 4) : 'N/D');
          
          return `
            <div class="media-card" onclick="${isTV ? 'showTVSeasons' : 'watchMovie'}(${item.id}, '${isTV ? 'tv' : 'movie'}')">
              <img src="${poster}" alt="${isTV ? item.name : item.title}" class="media-poster">
              <div class="media-info">
                <h3 class="media-title">${isTV ? item.name : item.title}</h3>
                <div class="media-meta">
                  <span>${isTV ? 'Serie TV' : 'Film'}</span>
                  <span>${year}</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
        

      } catch (error) {
        console.error("Search error:", error);
        container.innerHTML = `
          <div class="state-message">
            <i class="fas fa-exclamation-triangle"></i> Errore durante la ricerca
            <button onclick="searchMedia()" style="
              margin-top: 15px;
              background: var(--primary);
              color: white;
              border: none;
              padding: 8px 15px;
              border-radius: 5px;
              cursor: pointer;
            ">
              Riprova
            </button>
          </div>
        `;
      }
    }

    // Watch movie using vixsrc
async function watchMovie(movieId, type) {
  const playerContainer = document.getElementById("player-container");
  const playerIframe = document.getElementById("player-iframe");

  // Mostra loading temporaneo
  playerContainer.style.display = 'flex';
  playerContainer.innerHTML = `<div class="state-message">Caricamento player...</div>`;
  document.body.style.overflow = 'hidden';

  try {
    const res = await fetch(`https://vixproxy.onrender.com/proxy/movie/${movieId}`);
    const data = await res.json();

    if (!data.url) throw new Error("Nessun URL restituito");

    playerContainer.innerHTML = `
      <button class="close-player" onclick="closePlayer()">
        <i class="fas fa-times"></i>
      </button>
      <video id="video" controls autoplay crossorigin="anonymous" style="width: 80%; height: 80%; border-radius: 10px; background: black;"></video>
    `;

    const video = document.getElementById('video');
    const hls = new Hls();
    hls.loadSource(`https://vixproxy.onrender.com/stream?url=${encodeURIComponent(data.url)}`);
    hls.attachMedia(video);

  } catch (err) {
    console.error("Errore nel caricamento:", err);
    playerContainer.innerHTML = `
      <div class="state-message">
        <i class="fas fa-exclamation-triangle"></i> Errore durante il caricamento del player
        <button onclick="watchMovie(${movieId}, '${type}')">Riprova</button>
      </div>
    `;
  }
}


    // Show TV seasons selection
    async function showTVSeasons(tvId, type) {
      const playerContainer = document.getElementById("player-container");
      playerContainer.innerHTML = `
        <button class="close-player" onclick="closePlayer()">
          <i class="fas fa-times"></i>
        </button>
        <div style="width:80%; height:80%; overflow-y:auto; padding:20px;">
          <h2 style="margin-bottom:20px; text-align:center;">Seleziona Stagione</h2>
          <div id="seasons-container" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:15px;"></div>
        </div>
      `;
      
      try {
        const response = await fetch(
          `https://api.themoviedb.org/3/tv/${tvId}?api_key=${API_KEY}&language=it-IT`
        );
        const data = await response.json();
        
        const seasonsContainer = document.getElementById("seasons-container");
        seasonsContainer.innerHTML = data.seasons.map(season => `
          <div class="season-card" onclick="showEpisodes(${tvId}, ${season.season_number})" style="
            background: var(--gray);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s;
          ">
            <h3>Stagione ${season.season_number+1}</h3>
            <p>${season.episode_count} episodi</p>
          </div>
        `).join('');
        
        playerContainer.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
      } catch (error) {
        console.error("Error loading seasons:", error);
        playerContainer.innerHTML = `
          <button class="close-player" onclick="closePlayer()">
            <i class="fas fa-times"></i>
          </button>
          <div style="color:white; text-align:center; padding:40px;">
            <i class="fas fa-exclamation-triangle" style="font-size:2rem; margin-bottom:15px;"></i>
            <p>Errore nel caricamento delle stagioni</p>
            <button onclick="showTVSeasons(${tvId}, '${type}')" style="
              margin-top: 15px;
              background: var(--primary);
              color: white;
              border: none;
              padding: 8px 15px;
              border-radius: 5px;
              cursor: pointer;
            ">
              Riprova
            </button>
          </div>
        `;
      }
    }

    // Show episodes for selected season
    async function showEpisodes(tvId, seasonNumber) {
  currentTVData = { tvId, seasonNumber };
  isInEpisodeSelection = true;
  
  const playerContainer = document.getElementById("player-container");
  playerContainer.innerHTML = `
    <button class="close-player" onclick="closePlayer()">
      <i class="fas fa-times"></i>
    </button>
    <div class="episode-selection-view">
      <h2>Stagione ${seasonNumber+1} - Seleziona Episodio</h2>
      <div id="episodes-container" class="episodes-grid"></div>
    </div>
  `;
  
  try {
    const response = await fetch(`https://api.themoviedb.org/3/tv/${tvId}/season/${seasonNumber}?api_key=${API_KEY}&language=it-IT`);
    const data = await response.json();
    
    const episodesContainer = document.getElementById("episodes-container");
    episodesContainer.innerHTML = data.episodes.map(episode => `
  <div class="episode-card" onclick="playTVEpisode(${tvId}, ${seasonNumber}, ${episode.episode_number})">
    <h3>Episodio ${episode.episode_number}</h3>
    <p>${episode.name || 'Senza titolo'}</p>
    ${episode.still_path ? `
      <img src="https://image.tmdb.org/t/p/w300${episode.still_path}" 
           alt="${episode.name || 'Episodio'}"
           loading="lazy">` : ''}
  </div>
`).join('');
    
    playerContainer.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
  } catch (error) {
    console.error("Error loading episodes:", error);
    playerContainer.innerHTML = `
      <div class="error-message">
        <i class="fas fa-exclamation-triangle"></i>
        <p>Errore nel caricamento degli episodi</p>
        <button onclick="showEpisodes(${tvId}, ${seasonNumber})">Riprova</button>
      </div>
    `;
  }
}

function playTVEpisode(tvId, seasonNumber, episodeNumber) {
  isInEpisodeSelection = false;
  
  const playerContainer = document.getElementById("player-container");
  playerContainer.innerHTML = `
    <button class="close-player" onclick="closePlayer()">
      <i class="fas fa-times"></i>
    </button>
    <iframe class="player-iframe" 
            src="https://vixsrc.to/tv/${tvId}/${seasonNumber}/${episodeNumber}?lang=it&autoplay=false" 
            allowfullscreen></iframe>
  `;
}

    // Watch TV episode using vixsrc
    function watchTV(tvId, seasonNumber, episodeNumber) {
      const playerContainer = document.getElementById("player-container");
      const playerIframe = document.getElementById("player-iframe");
      
      // Ricrea l'iframe se è stato rimosso
      if (!playerIframe) {
        const newIframe = document.createElement('iframe');
        newIframe.className = 'player-iframe';
        newIframe.id = 'player-iframe';
        newIframe.allowfullscreen = true;
        playerContainer.appendChild(newIframe);
      }
      
      document.querySelector('.player-iframe').src = `https://vixsrc.to/tv/${tvId}/${seasonNumber}/${episodeNumber}?lang=it&autoplay=false`;
      playerContainer.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    // Close player
function closePlayer() {
  const playerContainer = document.getElementById("player-container");
  const iframe = playerContainer.querySelector("video");
  
  // Ferma il video
  if (video) {
    const iframeSrc = video.src;
    video.src = ""; // Questo ferma il video
  }
  
  playerContainer.style.display = 'none';
  document.body.style.overflow = 'auto';
  
  if (currentTVData && !isInEpisodeSelection) {
    // Ritorna alla selezione episodi se stavi guardando una serie
    showEpisodes(currentTVData.tvId, currentTVData.seasonNumber);
  } else {
    currentTVData = null;
    isInEpisodeSelection = false;
  }
}
  </script>
</body>
</html>